# Automated Build System

## Table of Contents

* [Introduction](#introduction)
* [Docker Triggered Builds](#triggering-builds-from-docker-github-repositories)
* [Source Code Triggered Builds](#triggering-builds-from-changes-to-source-code)
* [Stage and Production](#stage-and-production)
* [!Exception! (fedora-sample-data)](#exception)

## Introduction

There are a two main tools at play for our automated build system.

1. [Github](https://github.com/livingstoneonline)
2. [Docker Hub](https://hub.docker.com/r/livingstoneonline/)

Github houses the code for running everything on the site (themes, module code,
etc) as well as what's needed to generate our Docker Images (Dockerfiles).

Docker Hub generates the Docker Images from the code in Github and houses them
as well. After they are generated we can then download and use them or deploy
them to either stage or production.

## Triggering Builds from Docker Github Repositories 

Each of the Github repositories that correspond to Docker images (listed below),
are set to trigger a build in Docker Hub the second any change is made to them:

### Mariadb Images

1. Docker Hub:[mariadb](https://hub.docker.com/r/livingstoneonline/mariadb) 
   Github: [docker-mariadb](https://github.com/livingstoneonline/docker-mariadb)

### Drupal Images

1. Docker Hub:[drupal](https://hub.docker.com/r/livingstoneonline/drupal) 
   Github: [docker-drupal](https://github.com/livingstoneonline/docker-drupal)
2. Docker Hub:[islandora](https://hub.docker.com/r/livingstoneonline/islandora) 
   Github: [docker-islandora](https://github.com/livingstoneonline/docker-islandora)
3. Docker Hub:[livingstone](https://hub.docker.com/r/livingstoneonline/livingstone) 
   Github: [docker-livingstone](https://github.com/livingstoneonline/docker-livingstone)

### Tomcat Images

1. Docker Hub:[java](https://hub.docker.com/r/livingstoneonline/java) 
   Github: [docker-java](https://github.com/livingstoneonline/docker-java)
2. Docker Hub:[tomcat](https://hub.docker.com/r/livingstoneonline/tomcat) 
   Github: [docker-tomcat](https://github.com/livingstoneonline/docker-tomcat)
3. Docker Hub:[djatoka](https://hub.docker.com/r/livingstoneonline/djatoka) 
   Github: [docker-djatoka](https://github.com/livingstoneonline/docker-djatoka)
4. Docker Hub:[fedora](https://hub.docker.com/r/livingstoneonline/fedora) 
   Github: [docker-fedora](https://github.com/livingstoneonline/docker-fedora)
5. Docker Hub:[gsearch](https://hub.docker.com/r/livingstoneonline/docker) 
   Github: [docker-gsearch](https://github.com/livingstoneonline/docker-gsearch)

Since we have such a large number of nested Docker Images, we also propagate the
trigger to all dependent images in the order of their dependencies so they are
updated as well. So if *livingstoneonline/java* is changed, it will then cause
*livingstoneonline/tomcat* to be rebuild which in turn will trigger
*livingstone/djatoka* to be built, and so on.

## Triggering builds from changes to Source Code

In addition we also monitor a few other Github repositories and trigger builds
if they are changed. In Particular:

1. [livingstone_online_theme](https://github.com/livingstoneonline/livingstone_online_theme)
2. [livingstone_online_features](https://github.com/livingstoneonline/livingstone_online_features)

So if one where to add a new CSS file to the theme, Docker Hub will start to
build out a new *livingstoneonline/livingstone* Docker image.

## Stage & Production

For the most part all the Docker Images have only one version, which is shared
across all environments, so we can safely ignore them.

The exception being
[docker-livingstone](https://github.com/livingstoneonline/docker-livingstone),
which has separate branches for each environment. This allows us to run
different code locally, and to test out features and components on stage before
deploying them to production.

For each corresponding branch, a different Docker Image is build.

1. docker-livingstone:dev
2. docker-livingstone:stage
3. docker-livingstone:prod

Each of these different images are destined for our different environments.

## !Exception! (fedora-sample-data) 

Unfortunately
[docker-fedora-sample-data](https://github.com/livingstoneonline/docker-fedora-sample-data)
is not integrated into the automated build system, and must be generated by hand
and pushed manually. Github puts limits on large files, as such we must use
git-lfs to get this repository into Github, and unfortunately Docker Hub does
not support git-lfs, so automated builds are impossible. 

Fortunately we won't have to do that too often.
